# This job merges every commit to `master` into `nightly-testing`, resolving merge conflicts in favor of `nightly-testing`.

name: Merge master to nightly

on:
  schedule:
    - cron: '30 */3 * * *'  # At minute 30 past every 3rd hour.
  workflow_dispatch:

jobs:
  merge-to-nightly:
    runs-on: ubuntu-latest
    if: github.repository == 'leanprover-community/mathlib4'
    steps:
      - name: Checkout nightly-testing from fork
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          repository: leanprover-community/mathlib4-nightly-testing
          ref: nightly-testing
          path: nightly-testing
          token: ${{ secrets.NIGHTLY_TESTING }}
          fetch-depth: 0

      - name: Configure Lean
        uses: leanprover/lean-action@434f25c2f80ded67bba02502ad3a86f25db50709 # v1.3.0
        with:
          auto-config: false
          use-github-cache: false
          use-mathlib-cache: false
          lake-package-directory: "nightly-testing" # We will run `lake update` here later.

      - name: Configure Git User
        run: |
          cd nightly-testing
          git config user.name "leanprover-community-mathlib4-bot"
          git config user.email "leanprover-community-mathlib4-bot@users.noreply.github.com"

      - name: Merge master to nightly favoring nightly changes
        run: |
          cd nightly-testing
          git remote add upstream https://github.com/leanprover-community/mathlib4.git
          git fetch upstream master
          # Merge master into nightly-testing, resolving conflicts in favor of nightly-testing
          # If the merge goes badly, we proceed anyway via '|| true'.
          # CI will report failures on the 'nightly-testing' branch direct to Zulip.
          git merge upstream/master --strategy-option ours --no-commit --allow-unrelated-histories || true
          # We aggressively run `lake update`, to avoid having to do this by hand.
          # When Batteries changes break Mathlib, this will likely show up on nightly-testing first.
          lake update -v
          git add .
          # If there's nothing to do (because there are no new commits from master),
          # that's okay, hence the '|| true'.
          git commit -m "Merge master into nightly-testing" || true
          # Push to the mathlib4-nightly-testing fork
          git push origin nightly-testing
