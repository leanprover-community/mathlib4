#!/usr/bin/env bash
# Generate PR Summary Comment
# Reads JSON output from verify_commits.sh and generates a markdown comment
#
# Usage: ./scripts/verify_commits.sh <base_ref> --json | ./scripts/generate_pr_summary.sh <repo> <pr_number>

set -euo pipefail

REPO="${1:-}"
PR_NUMBER="${2:-}"

if [[ -z "$REPO" || -z "$PR_NUMBER" ]]; then
  echo "Usage: $0 <repo> <pr_number>" >&2
  echo "  Reads JSON from stdin" >&2
  exit 2
fi

# Read JSON from stdin
JSON=$(cat)

# Parse JSON using jq
SUCCESS=$(echo "$JSON" | jq -r '.success')
TRANSIENT_VERIFIED=$(echo "$JSON" | jq -r '.transient_verified')

SUBSTANTIVE_COUNT=$(echo "$JSON" | jq '.substantive_commits | length')
AUTO_COUNT=$(echo "$JSON" | jq '.auto_commits | length')
TRANSIENT_COUNT=$(echo "$JSON" | jq '.transient_commits | length')

# Count verified auto commits
AUTO_VERIFIED_COUNT=$(echo "$JSON" | jq '[.auto_commits[] | select(.verified == true)] | length')

# Generate markdown
cat << 'HEADER'
## Commit Verification Summary

HEADER

# Overall status
if [[ "$SUCCESS" == "true" ]]; then
  echo "All verifications passed."
  echo ""
else
  echo "> [!WARNING]"
  echo "> Some verifications failed. See details below."
  echo ""
fi

# Substantive commits section
if [[ "$SUBSTANTIVE_COUNT" -gt 0 ]]; then
  echo "### Commits to Review ($SUBSTANTIVE_COUNT)"
  echo ""
  echo "$JSON" | jq -r '.substantive_commits[] | "- `\(.short)`: \(.subject)"'
  echo ""

  # Generate diff link for substantive commits only
  # This links to a compare view - reviewers can focus on these
  FIRST_SUBSTANTIVE=$(echo "$JSON" | jq -r '.substantive_commits[0].sha // empty')
  if [[ -n "$FIRST_SUBSTANTIVE" ]]; then
    echo "[View PR diff](https://github.com/$REPO/pull/$PR_NUMBER/files)"
    echo ""
  fi
else
  echo "### Commits to Review"
  echo ""
  echo "No substantive commits - this PR consists entirely of automated and/or transient commits."
  echo ""
fi

# Automated commits section
if [[ "$AUTO_COUNT" -gt 0 ]]; then
  if [[ "$AUTO_VERIFIED_COUNT" -eq "$AUTO_COUNT" ]]; then
    STATUS_ICON="\\u2705"  # green checkmark
    STATUS_TEXT="verified"
  else
    STATUS_ICON="\\u274c"  # red X
    STATUS_TEXT="$AUTO_VERIFIED_COUNT/$AUTO_COUNT verified"
  fi

  echo "<details>"
  echo "<summary>$STATUS_ICON Automated commits ($AUTO_COUNT) - $STATUS_TEXT</summary>"
  echo ""
  echo "| Commit | Command | Status |"
  echo "|--------|---------|--------|"

  echo "$JSON" | jq -r '.auto_commits[] |
    if .verified then
      "| `\(.short)` | `\(.subject)` | \u2705 Verified |"
    else
      "| `\(.short)` | `\(.subject)` | \u274c \(.error // "Failed") |"
    end'

  echo ""
  echo "</details>"
  echo ""
fi

# Transient commits section
if [[ "$TRANSIENT_COUNT" -gt 0 ]]; then
  if [[ "$TRANSIENT_VERIFIED" == "true" ]]; then
    STATUS_ICON="\\u2705"
    STATUS_TEXT="net effect: none"
  else
    STATUS_ICON="\\u274c"
    TRANSIENT_ERROR=$(echo "$JSON" | jq -r '.transient_error // "Verification failed"')
    STATUS_TEXT="$TRANSIENT_ERROR"
  fi

  echo "<details>"
  echo "<summary>$STATUS_ICON Transient commits ($TRANSIENT_COUNT) - $STATUS_TEXT</summary>"
  echo ""
  echo "$JSON" | jq -r '.transient_commits[] | "- `\(.short)`: \(.subject)"'
  echo ""
  echo "</details>"
  echo ""
fi

# Footer
echo "---"
echo "*Generated by commit verification CI*"
