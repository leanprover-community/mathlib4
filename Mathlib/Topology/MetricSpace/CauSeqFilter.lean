/-
Copyright (c) 2018 Robert Y. Lewis. All rights reserved.
Released under Apache 2.0 license as described in the file LICENSE.
Authors: Robert Y. Lewis, SÃ©bastien GouÃ«zel
-/
import Mathlib.Analysis.Normed.Field.Basic

#align_import topology.metric_space.cau_seq_filter from "leanprover-community/mathlib"@"f2ce6086713c78a7f880485f7917ea547a215982"

/-!
# Completeness in terms of `Cauchy` filters vs `isCauSeq` sequences

In this file we apply `Metric.complete_of_cauchySeq_tendsto` to prove that a `NormedRing`
is complete in terms of `Cauchy` filter if and only if it is complete in terms
of `CauSeq` Cauchy sequences.
-/


universe u v

open Set Filter

open Topology Classical

variable {Î² : Type v}

theorem CauSeq.tendsto_limit [NormedRing Î²] [hn : IsAbsoluteValue (norm : Î² â†’ â„)]
    (f : CauSeq Î² norm) [CauSeq.IsComplete Î² norm] : Tendsto f atTop (ğ“ f.lim) :=
  tendsto_nhds.mpr
    (by
      intro s os lfs
      -- âŠ¢ â†‘f â»Â¹' s âˆˆ atTop
      suffices âˆƒ a : â„•, âˆ€ b : â„•, b â‰¥ a â†’ f b âˆˆ s by simpa using this
      -- âŠ¢ âˆƒ a, âˆ€ (b : â„•), b â‰¥ a â†’ â†‘f b âˆˆ s
      rcases Metric.isOpen_iff.1 os _ lfs with âŸ¨Îµ, âŸ¨hÎµ, hÎµsâŸ©âŸ©
      -- âŠ¢ âˆƒ a, âˆ€ (b : â„•), b â‰¥ a â†’ â†‘f b âˆˆ s
      cases' Setoid.symm (CauSeq.equiv_lim f) _ hÎµ with N hN
      -- âŠ¢ âˆƒ a, âˆ€ (b : â„•), b â‰¥ a â†’ â†‘f b âˆˆ s
      exists N
      -- âŠ¢ âˆ€ (b : â„•), b â‰¥ N â†’ â†‘f b âˆˆ s
      intro b hb
      -- âŠ¢ â†‘f b âˆˆ s
      apply hÎµs
      -- âŠ¢ â†‘f b âˆˆ Metric.ball (lim f) Îµ
      dsimp [Metric.ball]
      -- âŠ¢ dist (â†‘f b) (lim f) < Îµ
      rw [dist_comm, dist_eq_norm]
      -- âŠ¢ â€–lim f - â†‘f bâ€– < Îµ
      solve_by_elim)
      -- ğŸ‰ no goals
#align cau_seq.tendsto_limit CauSeq.tendsto_limit

variable [NormedField Î²]

/-
 This section shows that if we have a uniform space generated by an absolute value, topological
 completeness and Cauchy sequence completeness coincide. The problem is that there isn't
 a good notion of "uniform space generated by an absolute value", so right now this is
 specific to norm. Furthermore, norm only instantiates IsAbsoluteValue on NormedDivisionRing.
 This needs to be fixed, since it prevents showing that â„¤_[hp] is complete.
-/
open Metric

theorem CauchySeq.isCauSeq {f : â„• â†’ Î²} (hf : CauchySeq f) : IsCauSeq norm f := by
  cases' cauchy_iff.1 hf with hf1 hf2
  -- âŠ¢ IsCauSeq norm f
  intro Îµ hÎµ
  -- âŠ¢ âˆƒ i, âˆ€ (j : â„•), j â‰¥ i â†’ â€–f j - f iâ€– < Îµ
  rcases hf2 { x | dist x.1 x.2 < Îµ } (dist_mem_uniformity hÎµ) with âŸ¨t, âŸ¨ht, htsubâŸ©âŸ©
  -- âŠ¢ âˆƒ i, âˆ€ (j : â„•), j â‰¥ i â†’ â€–f j - f iâ€– < Îµ
  simp at ht; cases' ht with N hN
  -- âŠ¢ âˆƒ i, âˆ€ (j : â„•), j â‰¥ i â†’ â€–f j - f iâ€– < Îµ
              -- âŠ¢ âˆƒ i, âˆ€ (j : â„•), j â‰¥ i â†’ â€–f j - f iâ€– < Îµ
  exists N
  -- âŠ¢ âˆ€ (j : â„•), j â‰¥ N â†’ â€–f j - f Nâ€– < Îµ
  intro j hj
  -- âŠ¢ â€–f j - f Nâ€– < Îµ
  rw [â† dist_eq_norm]
  -- âŠ¢ dist (f j) (f N) < Îµ
  apply @htsub (f j, f N)
  -- âŠ¢ (f j, f N) âˆˆ t Ã—Ë¢ t
  apply Set.mk_mem_prod <;> solve_by_elim [le_refl]
  -- âŠ¢ f j âˆˆ t
                            -- ğŸ‰ no goals
                            -- ğŸ‰ no goals
#align cauchy_seq.is_cau_seq CauchySeq.isCauSeq

theorem CauSeq.cauchySeq (f : CauSeq Î² norm) : CauchySeq f := by
  refine' cauchy_iff.2 âŸ¨by infer_instance, fun s hs => _âŸ©
  -- âŠ¢ âˆƒ t, t âˆˆ map (â†‘f) atTop âˆ§ t Ã—Ë¢ t âŠ† s
  rcases mem_uniformity_dist.1 hs with âŸ¨Îµ, âŸ¨hÎµ, hÎµsâŸ©âŸ©
  -- âŠ¢ âˆƒ t, t âˆˆ map (â†‘f) atTop âˆ§ t Ã—Ë¢ t âŠ† s
  cases' CauSeq.cauchyâ‚‚ f hÎµ with N hN
  -- âŠ¢ âˆƒ t, t âˆˆ map (â†‘f) atTop âˆ§ t Ã—Ë¢ t âŠ† s
  exists { n | n â‰¥ N }.image f
  -- âŠ¢ â†‘f '' {n | n â‰¥ N} âˆˆ map (â†‘f) atTop âˆ§ (â†‘f '' {n | n â‰¥ N}) Ã—Ë¢ (â†‘f '' {n | n â‰¥  â€¦
  simp only [exists_prop, mem_atTop_sets, mem_map, mem_image, ge_iff_le, mem_setOf_eq]
  -- âŠ¢ (âˆƒ a, âˆ€ (b : â„•), a â‰¤ b â†’ b âˆˆ â†‘f â»Â¹' (â†‘f '' {n | N â‰¤ n})) âˆ§ (â†‘f '' {n | N â‰¤ n â€¦
  constructor
  -- âŠ¢ âˆƒ a, âˆ€ (b : â„•), a â‰¤ b â†’ b âˆˆ â†‘f â»Â¹' (â†‘f '' {n | N â‰¤ n})
  Â· exists N
    -- âŠ¢ âˆ€ (b : â„•), N â‰¤ b â†’ b âˆˆ â†‘f â»Â¹' (â†‘f '' {n | N â‰¤ n})
    intro b hb
    -- âŠ¢ b âˆˆ â†‘f â»Â¹' (â†‘f '' {n | N â‰¤ n})
    exists b
    -- ğŸ‰ no goals
  Â· rintro âŸ¨a, bâŸ© âŸ¨âŸ¨a', âŸ¨ha'1, ha'2âŸ©âŸ©, âŸ¨b', âŸ¨hb'1, hb'2âŸ©âŸ©âŸ©
    -- âŠ¢ (a, b) âˆˆ s
    dsimp at ha'1 ha'2 hb'1 hb'2
    -- âŠ¢ (a, b) âˆˆ s
    rw [â† ha'2, â† hb'2]
    -- âŠ¢ (â†‘f a', â†‘f b') âˆˆ s
    apply hÎµs
    -- âŠ¢ dist (â†‘f a') (â†‘f b') < Îµ
    rw [dist_eq_norm]
    -- âŠ¢ â€–â†‘f a' - â†‘f b'â€– < Îµ
    apply hN <;> assumption
    -- âŠ¢ a' â‰¥ N
                 -- ğŸ‰ no goals
                 -- ğŸ‰ no goals
#align cau_seq.cauchy_seq CauSeq.cauchySeq

/-- In a normed field, `CauSeq` coincides with the usual notion of Cauchy sequences. -/
theorem isCauSeq_iff_cauchySeq {Î± : Type u} [NormedField Î±] {u : â„• â†’ Î±} :
    IsCauSeq norm u â†” CauchySeq u :=
  âŸ¨fun h => CauSeq.cauchySeq âŸ¨u, hâŸ©, fun h => h.isCauSeqâŸ©
#align cau_seq_iff_cauchy_seq isCauSeq_iff_cauchySeq

-- see Note [lower instance priority]
/-- A complete normed field is complete as a metric space, as Cauchy sequences converge by
assumption and this suffices to characterize completeness. -/
instance (priority := 100) completeSpace_of_cauSeq_isComplete [CauSeq.IsComplete Î² norm] :
    CompleteSpace Î² := by
  apply complete_of_cauchySeq_tendsto
  -- âŠ¢ âˆ€ (u : â„• â†’ Î²), CauchySeq u â†’ âˆƒ a, Tendsto u atTop (ğ“ a)
  intro u hu
  -- âŠ¢ âˆƒ a, Tendsto u atTop (ğ“ a)
  have C : IsCauSeq norm u := isCauSeq_iff_cauchySeq.2 hu
  -- âŠ¢ âˆƒ a, Tendsto u atTop (ğ“ a)
  exists CauSeq.lim âŸ¨u, CâŸ©
  -- âŠ¢ Tendsto u atTop (ğ“ (CauSeq.lim { val := u, property := C }))
  rw [Metric.tendsto_atTop]
  -- âŠ¢ âˆ€ (Îµ : â„), Îµ > 0 â†’ âˆƒ N, âˆ€ (n : â„•), n â‰¥ N â†’ dist (u n) (CauSeq.lim { val := u â€¦
  intro Îµ Îµpos
  -- âŠ¢ âˆƒ N, âˆ€ (n : â„•), n â‰¥ N â†’ dist (u n) (CauSeq.lim { val := u, property := C })  â€¦
  cases' (CauSeq.equiv_lim âŸ¨u, CâŸ©) _ Îµpos with N hN
  -- âŠ¢ âˆƒ N, âˆ€ (n : â„•), n â‰¥ N â†’ dist (u n) (CauSeq.lim { val := u, property := C })  â€¦
  exists N
  -- âŠ¢ âˆ€ (n : â„•), n â‰¥ N â†’ dist (u n) (CauSeq.lim { val := u, property := C }) < Îµ
  simpa [dist_eq_norm] using hN
  -- ğŸ‰ no goals
#align complete_space_of_cau_seq_complete completeSpace_of_cauSeq_isComplete
