/-
Copyright (c) 2024 JoÃ«l Riou. All rights reserved.
Released under Apache 2.0 license as described in the file LICENSE.
Authors: JoÃ«l Riou
-/

import Mathlib.Algebra.Category.ModuleCat.Sheaf.Free

/-!
# Generating sections of sheaves of modules

In this file, given a sheaf of modules `M` over a sheaf of rings `R`, we introduce
the structure `M.GeneratingSections` which consists of a family of (global)
sections `s : I â†’ M.sections` which generate `M`.

-/

universe u v' u'
open CategoryTheory Limits

variable {C : Type u'} [Category.{v'} C] {J : GrothendieckTopology C} {R : Sheaf J RingCat.{u}}
  [HasWeakSheafify J AddCommGrp.{u}] [J.WEqualsLocallyBijective AddCommGrp.{u}]
  [J.HasSheafCompose (forgetâ‚‚ RingCat.{u} AddCommGrp.{u})]

namespace SheafOfModules

variable (M N P : SheafOfModules.{u} R)

/-- The type of sections which generate a sheaf of modules. -/
structure GeneratingSections where
  /-- the index type for the sections -/
  I : Type u
  /-- a family of sections which generate the sheaf of modules -/
  s : I â†’ M.sections
  epi : Epi (M.freeHomEquiv.symm s) := by infer_instance

namespace GeneratingSections

attribute [instance] epi

variable {M N P}

/-- If `M âŸ¶ N` is an epimorphisms and that `M` is generated by some sections,
then `N` is generated by the images of these sections. -/
@[simps]
def ofEpi (Ïƒ : M.GeneratingSections) (p : M âŸ¶ N) [Epi p] :
    N.GeneratingSections where
  I := Ïƒ.I
  s i := sectionsMap p (Ïƒ.s i)
  epi := by
    rw [â† freeHomEquiv_symm_comp]
    apply epi_comp

attribute [local instance] epi_comp

lemma opEpi_id (Ïƒ : M.GeneratingSections) :
    Ïƒ.ofEpi (ğŸ™ M) = Ïƒ := rfl

lemma opEpi_comp (Ïƒ : M.GeneratingSections) (p : M âŸ¶ N) (q : N âŸ¶ P) [Epi p] [Epi q] :
    Ïƒ.ofEpi (p â‰« q) = (Ïƒ.ofEpi p).ofEpi q := rfl

/-- Two isomorphic sheaves of modules have equivalent families of generating sections. -/
def equivOfIso (e : M â‰… N) :
    M.GeneratingSections â‰ƒ N.GeneratingSections where
  toFun Ïƒ := Ïƒ.ofEpi e.hom
  invFun Ïƒ := Ïƒ.ofEpi e.inv
  left_inv Ïƒ := by
    dsimp
    simp only [â† opEpi_comp, e.hom_inv_id, opEpi_id]
  right_inv Ïƒ := by
    dsimp
    simp only [â† opEpi_comp, e.inv_hom_id, opEpi_id]

end GeneratingSections

end SheafOfModules
