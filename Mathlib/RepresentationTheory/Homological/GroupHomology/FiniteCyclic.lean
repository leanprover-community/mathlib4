/-
Copyright (c) 2025 Amelia Livingston. All rights reserved.
Released under Apache 2.0 license as described in the file LICENSE.
Authors: Amelia Livingston
-/
import Mathlib.RepresentationTheory.Homological.FiniteCyclic

/-!
# Group cohomology of a finite cyclic group

Let `k` be a commutative ring and `G` a finite commutative group. Given `g : G` and `A : Rep k G`,
we can define a periodic chain complex in `Rep k G` given by
`... âŸ¶ A --N--> A --(Ï(g) - ğŸ™)--> A --N--> A --(Ï(g) - ğŸ™)--> A âŸ¶ 0`
where `N` is the norm map. When `G` is generated by `g` and `A` is the left regular representation
`k[G]`, it is a projective resolution of `k` as a trivial representation.

yadda yadda. -/

universe v u

open CategoryTheory Representation Finsupp Limits

namespace Rep.finiteCyclicGroup

variable {k G : Type u} [CommRing k] [CommGroup G] [Fintype G] (g : G)
  (hg : âˆ€ x, x âˆˆ Subgroup.zpowers g) (A : Rep k G)

open ModuleCat.MonoidalCategory in
/-- Given a finite cyclic group `G` generated by `g : G` and a `k`-linear `G`-representation `A`,
the period chain complex
```
... âŸ¶ (A âŠ—â‚– k[G])_G --âŸ¦Id âŠ— NâŸ§--> (A âŠ—â‚– k[G])_G --âŸ¦Id âŠ— (Ï(g) - ğŸ™)âŸ§--> (A âŠ—â‚– k[G])_G âŸ¶ 0
```
is isomorphic as a complex in `ModuleCat k` to
```
... âŸ¶ A --N--> A --(Ï(g) - ğŸ™)--> A --N--> A --(Ï(g) - ğŸ™)--> A âŸ¶ 0
```
-/
@[simps!]
noncomputable def coinvariantsTensorResolutionIso {G : Type u} [CommGroup G] [Fintype G] (g : G)
    (hg : âˆ€ x, x âˆˆ Subgroup.zpowers g) (A : Rep k G) :
    (resolution k gâ»Â¹ ((@Subgroup.zpowers_inv G ..).symm â–¸ hg)).complex.coinvariantsTensorObj A â‰…
      moduleCatChainComplex A g :=
  HomologicalComplex.Hom.isoOfComponents
    (fun _ => (coinvariantsTprodLeftRegularLEquiv A.Ï).toModuleIso) fun i j h =>
    coinvariantsTensor_hom_ext (LinearMap.ext fun a => lhom_ext' fun g => LinearMap.ext_ring (by
    subst h
    by_cases hj : Even (j + 1)
    Â· simpa [hj, whiskerLeft_def, coinvariantsTensorMk, whiskerLeft,
        tensorObj_def, ofCoinvariantsTprodLeftRegular, tensorObj, Representation.norm,
        â† Module.End.mul_apply, â† map_mul, mul_comm gâ»Â¹]
        using Finset.sum_bijective _ (MulEquiv.inv G).bijective (by aesop) (by aesop)
    Â· simp [sub_eq_add_neg, hj, whiskerLeft_def, coinvariantsTensorMk,
        whiskerLeft, tensorObj_def, tensorObj, â† Module.End.mul_apply, â† map_mul, mul_comm gâ»Â¹]))

/-- Given a finite cyclic group `G` generated by `g` and `A : Rep k G`, `Hâ‚€(G, A)` is isomorphic
to the cokernel of `Ï(g) - Id(A)`. -/
noncomputable def groupHomologyIsoâ‚€
    {G : Type u} [CommGroup G] [Fintype G] [DecidableEq G] (g : G)
    (hg : âˆ€ x, x âˆˆ Subgroup.zpowers g) (A : Rep k G) :
    groupHomology A 0 â‰…
      (ShortComplex.mk (Xâ‚ƒ := A.V) (applyAsHom A g - ğŸ™ A).hom _ comp_zero).opcycles :=
  groupHomologyIso A 0 (resolution k gâ»Â¹ <| (@Subgroup.zpowers_inv G ..).symm â–¸ hg) â‰ªâ‰«
  HomologicalComplex.homologyMapIso (coinvariantsTensorResolutionIso g hg A) 0 â‰ªâ‰«
  ChainComplex.isoHomologyÎ¹â‚€ _ â‰ªâ‰«
  ShortComplex.opcyclesMapIso (HomologicalComplex.isoSc' _ 1 0 0 (by simp) (by simp))

/-- Given a finite cyclic group `G` generated by `g` and `A : Rep k G`, `Háµ¢(G, A)` is isomorphic
to the homology of the short complex of `k`-modules `A --(Ï(g) - ğŸ™)--> A --N--> A` when `i` is
nonzero and even. -/
noncomputable def groupHomologyEvenIso
    {G : Type u} [CommGroup G] [Fintype G] [DecidableEq G] (g : G)
    (hg : âˆ€ x, x âˆˆ Subgroup.zpowers g) (A : Rep k G) (i : â„•) [hâ‚€ : NeZero i] (hi : Even i) :
    groupHomology A i â‰… (subCompNormHom A g).homology :=
  groupHomologyIso A i (resolution k gâ»Â¹ <| (@Subgroup.zpowers_inv G ..).symm â–¸ hg) â‰ªâ‰«
  (HomologicalComplex.homologyMapIso (coinvariantsTensorResolutionIso g hg A) i) â‰ªâ‰«
  HomologicalComplex.alternatingConstHomologyEvenIso A.V (by ext; simp [sub_eq_add_neg])
    (by ext; simp [sub_eq_add_neg]) _ (by aesop)
    (by induction i generalizing hâ‚€ with | zero => exact (NeZero.ne 0 rfl).elim | succ n _ => simp)
    hi

namespace groupHomology

/-- Given a finite cyclic group `G` generated by `g` and `A : Rep k G`, this is the quotient map
`Ker(N) âŸ¶ Ker(N)/Im(Ï(g) - Id(A)) â‰… Háµ¢(G, A)` for any nonzero even `i`. -/
noncomputable abbrev Ï€Even
    {G : Type u} [CommGroup G] [Fintype G] [DecidableEq G] (g : G)
    (hg : âˆ€ x, x âˆˆ Subgroup.zpowers g) (A : Rep k G) (i : â„•) [NeZero i] (hi : Even i) :
    ModuleCat.of k (LinearMap.ker A.Ï.norm) âŸ¶ groupHomology A i :=
    (ShortComplex.moduleCatCyclesIso <| subCompNormHom A g).inv â‰«
      ShortComplex.homologyÏ€ _ â‰« (groupHomologyEvenIso g hg A i hi).inv

lemma Ï€Even_eq_zero_iff
    {G : Type u} [CommGroup G] [Fintype G] [DecidableEq G] (g : G)
    (hg : âˆ€ x, x âˆˆ Subgroup.zpowers g) (A : Rep k G) (i : â„•) [NeZero i] (hi : Even i)
    (x : LinearMap.ker A.Ï.norm) :
    Ï€Even g hg A i hi x = 0 â†” x.1 âˆˆ LinearMap.range (applyAsHom A g - ğŸ™ A).hom.hom := by
  simp [Ï€Even, map_eq_zero_iff _ ((ModuleCat.mono_iff_injective _).1 inferInstance),
    ShortComplex.moduleCatToCycles, -LinearMap.mem_range, LinearMap.range_codRestrict]

lemma Ï€Even_eq_iff {G : Type u} [CommGroup G] [Fintype G] [DecidableEq G] (g : G)
    (hg : âˆ€ x, x âˆˆ Subgroup.zpowers g) (A : Rep k G) (i : â„•) [NeZero i] (hi : Even i)
    (x y : LinearMap.ker A.Ï.norm) :
    Ï€Even g hg A i hi x = Ï€Even g hg A i hi y â†”
      x.1 - y.1 âˆˆ LinearMap.range (applyAsHom A g - ğŸ™ A).hom.hom := by
  rw [â† sub_eq_zero, â† map_sub, Ï€Even_eq_zero_iff]; rfl


/-- Given a finite cyclic group `G` generated by `g` and `A : Rep k G`, `Hâ±(G, A)` is isomorphic
to the homology of the short complex of `k`-modules `A --N--> A --(Ï(g) - ğŸ™)--> A` when `i` is
odd. -/
noncomputable def groupHomologyOddIso
    {G : Type u} [CommGroup G] [Fintype G] [DecidableEq G] (g : G)
    (hg : âˆ€ x, x âˆˆ Subgroup.zpowers g) (A : Rep k G) (i : â„•) (hi : Odd i) :
    groupHomology A i â‰… (normHomCompSub A g).homology :=
  groupHomologyIso A i (resolution k gâ»Â¹ <| (@Subgroup.zpowers_inv G ..).symm â–¸ hg) â‰ªâ‰«
  (HomologicalComplex.homologyMapIso (coinvariantsTensorResolutionIso g hg A) i) â‰ªâ‰«
  HomologicalComplex.alternatingConstHomologyOddIso A.V (by ext; simp [sub_eq_add_neg])
    (by ext; simp [sub_eq_add_neg]) (by aesop) (by simp) (by rcases hi with âŸ¨j, rflâŸ©; simp) hi

/-- Given a finite cyclic group `G` generated by `g` and `A : Rep k G`, this is the quotient map
`Ker(Ï(g) - Id(A)) âŸ¶ Ker(Ï(g) - Id(A))/Im(N) â‰… Háµ¢(G, A)` for any odd `i`. -/
noncomputable abbrev Ï€Odd
    {G : Type u} [CommGroup G] [Fintype G] [DecidableEq G] (g : G)
    (hg : âˆ€ x, x âˆˆ Subgroup.zpowers g) (A : Rep k G) (i : â„•) (hi : Odd i) :
    ModuleCat.of k (LinearMap.ker (applyAsHom A g - ğŸ™ A).hom.hom) âŸ¶ groupHomology A i :=
    (ShortComplex.moduleCatCyclesIso <| normHomCompSub A g).inv â‰«
      ShortComplex.homologyÏ€ _ â‰« (groupHomologyOddIso g hg A i hi).inv

lemma Ï€Odd_eq_zero_iff
    {G : Type u} [CommGroup G] [Fintype G] [DecidableEq G] (g : G)
    (hg : âˆ€ x, x âˆˆ Subgroup.zpowers g) (A : Rep k G) (i : â„•) (hi : Odd i)
    (x : LinearMap.ker (applyAsHom A g - ğŸ™ A).hom.hom) :
    Ï€Odd g hg A i hi x = 0 â†” x.1 âˆˆ LinearMap.range A.Ï.norm := by
  simp [Ï€Odd, map_eq_zero_iff _ ((ModuleCat.mono_iff_injective _).1 inferInstance),
    ShortComplex.moduleCatToCycles, -LinearMap.mem_range, LinearMap.range_codRestrict]

lemma Ï€Odd_eq_iff {G : Type u} [CommGroup G] [Fintype G] [DecidableEq G] (g : G)
    (hg : âˆ€ x, x âˆˆ Subgroup.zpowers g) (A : Rep k G) (i : â„•) (hi : Odd i)
    (x y : LinearMap.ker (applyAsHom A g - ğŸ™ A).hom.hom) :
    Ï€Odd g hg A i hi x = Ï€Odd g hg A i hi y â†”
      x.1 - y.1 âˆˆ LinearMap.range A.Ï.norm := by
  rw [â† sub_eq_zero, â† map_sub, Ï€Odd_eq_zero_iff]; rfl

end groupHomology
end finiteCyclicGroup
end Rep
