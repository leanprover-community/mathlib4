/-
Copyright (c) 2025 Amelia Livingston. All rights reserved.
Released under Apache 2.0 license as described in the file LICENSE.
Authors: Amelia Livingston
-/
module

public import Mathlib.RepresentationTheory.Homological.FiniteCyclic
public import Mathlib.RepresentationTheory.Homological.GroupCohomology.LowDegree

/-!
# Group cohomology of a finite cyclic group

Let `k` be a commutative ring, `G` a group and `A` a `k`-linear `G`-representation. Given
endomorphisms `œÜ, œà : A ‚ü∂ A` such that `œÜ ‚àò œà = œà ‚àò œÜ = 0`, denote by `Chains(A, œÜ, œà)` the
periodic chain complex `... ‚ü∂ A --œÜ--> A --œà--> A --œÜ--> A --œà--> A ‚ü∂ 0` and by
`Cochains(A, œÜ, œà)` the periodic cochain complex
`0 ‚ü∂ A --œà--> A --œÜ--> A --œà--> A --œÜ--> A ‚ü∂ ...`.

When `G` is finite and generated by `g : G`, then `P := Chains(k[G], N, œÅ(g) - Id)` (with `œÅ` the
left regular representation) is a projective resolution of `k` as a trivial representation.
In this file we show that for `A : Rep k G`, `Hom(P, A)` is isomorphic to
`Cochains(A, N, œÅ_A(g) - Id)` as a complex of `k`-modules, and hence the cohomology of this complex
computes group cohomology.

## Main definitions

* `Rep.FiniteCyclicGroup.groupCohomologyIso‚ÇÄ A g hg`: given a finite cyclic group `G` generated by
  `g` and a representation `A : Rep k G`, this is an isomorphism `H‚Å∞(G, A) ‚âÖ Ker(œÅ_A(g) - Id)`.
* `Rep.FiniteCyclicGroup.groupCohomologyIsoOdd A g hg i hi`: given a finite cyclic group `G`
  generated by `g` and a representation `A : Rep k G`, this is an isomorphism between `H‚Å±(G, A)`
  and the homology of `A --(œÅ(g) - Id)--> A --N--> A` for all odd `i`.
* `Rep.FiniteCyclicGroup.groupCohomologyIsoEven A g hg i hi`: given a finite cyclic group `G`
  generated by `g`, and a representation `A : Rep k G`, this is an isomorphism between `H‚Å±(G, A)`
  and the homology of `A --N--> A --(œÅ(g) - Id)--> A` for all positive even `i`.

-/

@[expose] public section

universe v u

open CategoryTheory

namespace Rep.FiniteCyclicGroup

variable {k G : Type u} [CommRing k] [CommGroup G] [Fintype G] (A : Rep k G) (g : G)
  (hg : ‚àÄ x, x ‚àà Subgroup.zpowers g)

/-- Given a finite cyclic group `G` generated by `g : G` and a `k`-linear `G`-representation `A`,
the periodic cochain complex
`0 ‚ü∂ Hom(k[G], A) --(- ‚àò (œÅ(g) - ùüô))--> Hom(k[G], A) --(- ‚àò N)--> Hom(k[G], A) ‚ü∂ ...`
is isomorphic as a complex in `ModuleCat k` to
`0 ‚ü∂ A --(œÅ(g) - ùüô)--> A --N--> A --(œÅ(g) - ùüô)--> A --N--> A ‚ü∂ ...`. -/
@[simps!]
noncomputable def homResolutionIso :
    (resolution k g hg).complex.linearYonedaObj k A ‚âÖ moduleCatCochainComplex A g :=
  HomologicalComplex.Hom.isoOfComponents (fun _ => (leftRegularHomEquiv A).toModuleIso) <| by
    rintro i j ‚ü®rfl‚ü©
    ext (x : leftRegular _ _ ‚ü∂ _)
    by_cases hi : Even i
    ¬∑ have : ¬¨(Even (i + 1)) := Nat.even_add_one.not_left.mpr hi
      simp [hi, this, ‚Üê hom_comm_apply x]
    ¬∑ simp [hi, Nat.even_add_one.2 hi, Representation.norm, ‚Üê hom_comm_apply x]

open ShortComplex Limits

/-- Given a finite cyclic group `G` generated by `g` and `A : Rep k G`, `H‚Å∞(G, A)` is isomorphic
to the kernel of `œÅ(g) - Id(A)`. -/
noncomputable abbrev groupCohomologyIso‚ÇÄ :
    groupCohomology A 0 ‚âÖ ModuleCat.of k (LinearMap.ker (applyAsHom A g - ùüô A).hom.hom) :=
  groupCohomology.H0Iso A ‚â™‚â´ (LinearEquiv.ofEq _ _ <| by ext; simpa [sub_eq_zero]
    using Representation.mem_invariants_iff_of_forall_mem_zpowers A.œÅ g hg _).toModuleIso

/-- Given a finite cyclic group `G` generated by `g` and `A : Rep k G`, `H‚Å±(G, A)` is isomorphic
to the homology of the short complex of `k`-modules `A --N--> A --(œÅ(g) - ùüô)--> A` when `i` is
nonzero and even. -/
noncomputable def groupCohomologyIsoEven (i : ‚Ñï) [h‚ÇÄ : NeZero i] (hi : Even i) :
    groupCohomology A i ‚âÖ (normHomCompSub A g).homology :=
  groupCohomologyIso A i (resolution k g hg) ‚â™‚â´
  (HomologicalComplex.homologyMapIso (homResolutionIso A g hg) i) ‚â™‚â´
  HomologicalComplex.alternatingConstHomologyIsoEven A.V (by ext; simp) (by ext; simp) (by simp)
    (by induction i generalizing h‚ÇÄ with | zero => exact (NeZero.ne 0 rfl).elim | succ n _ => simp)
    (by simp) hi

/-- Given a finite cyclic group `G` generated by `g` and `A : Rep k G`, this is the quotient map
`Ker(œÅ(g) - Id(A)) ‚ü∂ Ker(œÅ(g) - Id(A))/Im(N) ‚âÖ H‚Å±(G, A)` for any nonzero even `i`. -/
noncomputable abbrev groupCohomologyœÄEven (i : ‚Ñï) [NeZero i] (hi : Even i) :
    ModuleCat.of k (LinearMap.ker (applyAsHom A g - ùüô A).hom.hom) ‚ü∂ groupCohomology A i :=
  (moduleCatCyclesIso <| normHomCompSub A g).inv ‚â´
      ShortComplex.homologyœÄ _ ‚â´ (groupCohomologyIsoEven A g hg i hi).inv

lemma groupCohomologyœÄEven_eq_zero_iff (i : ‚Ñï) [NeZero i] (hi : Even i)
    (x : LinearMap.ker (applyAsHom A g - ùüô A).hom.hom) :
    groupCohomologyœÄEven A g hg i hi x = 0 ‚Üî x.1 ‚àà LinearMap.range A.norm.hom.hom := by
  simp [groupCohomologyœÄEven, map_eq_zero_iff _ ((ModuleCat.mono_iff_injective _).1 inferInstance),
    moduleCatToCycles, -LinearMap.mem_range, LinearMap.range_codRestrict]

lemma groupCohomologyœÄEven_eq_iff (i : ‚Ñï) [NeZero i] (hi : Even i)
    (x y : LinearMap.ker (applyAsHom A g - ùüô A).hom.hom) :
    groupCohomologyœÄEven A g hg i hi x = groupCohomologyœÄEven A g hg i hi y ‚Üî
      x.1 - y.1 ‚àà LinearMap.range A.norm.hom.hom := by
  rw [‚Üê sub_eq_zero, ‚Üê map_sub, groupCohomologyœÄEven_eq_zero_iff]; rfl

/-- Given a finite cyclic group `G` generated by `g` and `A : Rep k G`, `H‚Å±(G, A)` is isomorphic
to the homology of the short complex of `k`-modules `A --(œÅ(g) - ùüô)--> A --N--> A` when `i` is
odd. -/
noncomputable def groupCohomologyIsoOdd (i : ‚Ñï) (hi : Odd i) :
    groupCohomology A i ‚âÖ (subCompNormHom A g).homology :=
  groupCohomologyIso A i (resolution k g hg) ‚â™‚â´
  (HomologicalComplex.homologyMapIso (homResolutionIso A g hg) i) ‚â™‚â´
  HomologicalComplex.alternatingConstHomologyIsoOdd A.V (by ext; simp) (by ext; simp)
    (by simp) (by rcases hi with ‚ü®j, rfl‚ü©; simp) (by simp) hi

/-- Given a finite cyclic group `G` generated by `g` and `A : Rep k G`, this is the quotient map
`Ker(N) ‚ü∂ Ker(N)/Im(œÅ(g) - Id(A)) ‚âÖ H‚Å±(G, A)` for any odd `i`. -/
noncomputable abbrev groupCohomologyœÄOdd (i : ‚Ñï) (hi : Odd i) :
    ModuleCat.of k (LinearMap.ker A.norm.hom.hom) ‚ü∂ groupCohomology A i :=
  (moduleCatCyclesIso <| subCompNormHom A g).inv ‚â´
      ShortComplex.homologyœÄ _ ‚â´ (groupCohomologyIsoOdd A g hg i hi).inv

lemma groupCohomologyœÄOdd_eq_zero_iff (i : ‚Ñï) (hi : Odd i) (x : LinearMap.ker A.norm.hom.hom) :
    groupCohomologyœÄOdd A g hg i hi x = 0 ‚Üî
      x.1 ‚àà LinearMap.range (applyAsHom A g - ùüô A).hom.hom := by
  simp [groupCohomologyœÄOdd, map_eq_zero_iff _ ((ModuleCat.mono_iff_injective _).1 inferInstance),
    moduleCatToCycles, -LinearMap.mem_range, LinearMap.range_codRestrict]

lemma groupCohomologyœÄOdd_eq_iff (i : ‚Ñï) (hi : Odd i) (x y : LinearMap.ker A.norm.hom.hom) :
    groupCohomologyœÄOdd A g hg i hi x = groupCohomologyœÄOdd A g hg i hi y ‚Üî
      x.1 - y.1 ‚àà LinearMap.range (applyAsHom A g - ùüô A).hom.hom := by
  rw [‚Üê sub_eq_zero, ‚Üê map_sub, groupCohomologyœÄOdd_eq_zero_iff, AddSubgroupClass.coe_sub]

end Rep.FiniteCyclicGroup
