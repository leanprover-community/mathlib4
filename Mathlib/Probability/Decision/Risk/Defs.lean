/-
Copyright (c) 2025 RÃ©my Degenne. All rights reserved.
Released under Apache 2.0 license as described in the file LICENSE.
Authors: RÃ©my Degenne, Lorenzo Luccioli
-/

import Mathlib.Probability.Kernel.Composition.Comp

/-!
# Risk of an estimator

An estimation problem is defined by a parameter space `Î˜`, a data generating kernel `P : Kernel Î˜ ğ“§`
and a loss function `â„“ : Î˜ â†’ ğ“¨ â†’ â„â‰¥0âˆ`.
A (randomized) estimator is a kernel `Îº : Kernel ğ“§ ğ“¨` that maps data to estimates of a quantity
of interest that depends on the parameter. Often the quantity of interest is the parameter itself
and `ğ“¨ = Î˜`.
The quality of an estimate `y` when data comes from the distribution with parameter `Î¸` is measured
by the value of the loss function `â„“ Î¸ y` (lower is better).

## Main definitions

The risk is the average loss of the estimator `Îº` on data generated by `P` with parameter `Î¸`,
equal to `âˆ«â» y, â„“ Î¸ y âˆ‚((Îº âˆ˜â‚– P) Î¸)`. We do not introduce a definition for that risk, but we refer
to that integral as `risk` in lemma names.

* `avgRisk â„“ P Îº Ï€`: the average of the risk of the estimator with respect to
  the prior `Ï€ : Measure Î˜`.
* `bayesRisk â„“ P Ï€`: the Bayes risk with respect to the prior `Ï€`, minimum of the average
  risks over all estimators, that is over all Markov kernels `Îº : Kernel ğ“§ ğ“¨`.
* `minimaxRisk â„“ P`: minimax risk, infimum over all estimators of the maximum over `Î¸` of the risk.

-/

open MeasureTheory
open scoped ENNReal

namespace ProbabilityTheory

variable {Î˜ ğ“§ ğ“¨ : Type*} {mÎ˜ : MeasurableSpace Î˜} {mğ“§ : MeasurableSpace ğ“§}

/-- The average risk of an estimator `Îº` on an estimation task with loss `â„“` and
data generating kernel `P` with respect to a prior `Ï€`. -/
noncomputable
def avgRisk {mğ“¨ : MeasurableSpace ğ“¨}
    (â„“ : Î˜ â†’ ğ“¨ â†’ â„â‰¥0âˆ) (P : Kernel Î˜ ğ“§) (Îº : Kernel ğ“§ ğ“¨) (Ï€ : Measure Î˜) : â„â‰¥0âˆ :=
  âˆ«â» Î¸, âˆ«â» y, â„“ Î¸ y âˆ‚((Îº âˆ˜â‚– P) Î¸) âˆ‚Ï€

/-- The Bayes risk with respect to a prior `Ï€`, defined as the infimum of the average risks of all
estimators. -/
noncomputable
def bayesRisk [MeasurableSpace ğ“¨] (â„“ : Î˜ â†’ ğ“¨ â†’ â„â‰¥0âˆ) (P : Kernel Î˜ ğ“§) (Ï€ : Measure Î˜) : â„â‰¥0âˆ :=
  â¨… (Îº : Kernel ğ“§ ğ“¨) (_ : IsMarkovKernel Îº), avgRisk â„“ P Îº Ï€

/-- The minimax risk, defined as the infimum over estimators of the maximal risk of
the estimator. -/
noncomputable
def minimaxRisk [MeasurableSpace ğ“¨] (â„“ : Î˜ â†’ ğ“¨ â†’ â„â‰¥0âˆ) (P : Kernel Î˜ ğ“§) : â„â‰¥0âˆ :=
  â¨… (Îº : Kernel ğ“§ ğ“¨) (_ : IsMarkovKernel Îº), â¨† Î¸, âˆ«â» y, â„“ Î¸ y âˆ‚((Îº âˆ˜â‚– P) Î¸)

variable {mğ“¨ : MeasurableSpace ğ“¨}
  {â„“ : Î˜ â†’ ğ“¨ â†’ â„â‰¥0âˆ} {P : Kernel Î˜ ğ“§} {Îº : Kernel ğ“§ ğ“¨} {Ï€ : Measure Î˜}

section Zero

@[simp]
lemma avgRisk_zero_left (â„“ : Î˜ â†’ ğ“¨ â†’ â„â‰¥0âˆ) (Îº : Kernel ğ“§ ğ“¨) (Ï€ : Measure Î˜) :
    avgRisk â„“ (0 : Kernel Î˜ ğ“§) Îº Ï€ = 0 := by simp [avgRisk]

@[simp]
lemma avgRisk_zero_right (â„“ : Î˜ â†’ ğ“¨ â†’ â„â‰¥0âˆ) (P : Kernel Î˜ ğ“§) (Ï€ : Measure Î˜) :
    avgRisk â„“ P (0 : Kernel ğ“§ ğ“¨) Ï€ = 0 := by simp [avgRisk]

@[simp]
lemma avgRisk_zero_prior (â„“ : Î˜ â†’ ğ“¨ â†’ â„â‰¥0âˆ) (P : Kernel Î˜ ğ“§) (Îº : Kernel ğ“§ ğ“¨) :
    avgRisk â„“ P Îº 0 = 0 := by simp [avgRisk]

@[simp]
lemma bayesRisk_zero_left [Nonempty ğ“¨] (â„“ : Î˜ â†’ ğ“¨ â†’ â„â‰¥0âˆ) (Ï€ : Measure Î˜) :
    bayesRisk â„“ (0 : Kernel Î˜ ğ“§) Ï€ = 0 := by simp [bayesRisk, iInf_subtype']

@[simp]
lemma bayesRisk_zero_right [Nonempty ğ“¨] (â„“ : Î˜ â†’ ğ“¨ â†’ â„â‰¥0âˆ) (P : Kernel Î˜ ğ“§) :
    bayesRisk â„“ P (0 : Measure Î˜) = 0 := by simp [bayesRisk, iInf_subtype']

@[simp]
lemma minimaxRisk_zero [Nonempty ğ“¨] (â„“ : Î˜ â†’ ğ“¨ â†’ â„â‰¥0âˆ) :
    minimaxRisk â„“ (0 : Kernel Î˜ ğ“§) = 0 := by simp [minimaxRisk, iInf_subtype']

end Zero

section Empty

@[simp]
lemma avgRisk_of_isEmpty [IsEmpty ğ“§] : avgRisk â„“ P Îº Ï€ = 0 := by
  simp [Subsingleton.elim P 0]

@[simp]
lemma avgRisk_of_isEmpty' [IsEmpty ğ“¨] : avgRisk â„“ P Îº Ï€ = 0 := by
  simp [Subsingleton.elim Îº 0]

@[simp]
lemma avgRisk_of_isEmpty'' [IsEmpty Î˜] : avgRisk â„“ P Îº Ï€ = 0 := by
  simp [avgRisk]

@[simp]
lemma bayesRisk_of_isEmpty [IsEmpty ğ“§] : bayesRisk â„“ P Ï€ = 0 := by
  simp [bayesRisk]

@[simp]
lemma bayesRisk_of_isEmpty' [Nonempty ğ“§] [IsEmpty ğ“¨] :
    bayesRisk â„“ P Ï€ = âˆ := by
  have : IsEmpty (Subtype (@IsMarkovKernel ğ“§ ğ“¨ mğ“§ mğ“¨)) := by
    simp only [isEmpty_subtype]
    exact fun Îº â†¦ Subsingleton.elim Îº 0 â–¸ Kernel.not_isMarkovKernel_zero
  simp [bayesRisk, iInf_subtype']

@[simp]
lemma bayesRisk_of_isEmpty'' [IsEmpty Î˜] [Nonempty ğ“¨] :
    bayesRisk â„“ P Ï€ = 0 := by
  simp [bayesRisk, iInf_subtype']

@[simp]
lemma minimaxRisk_of_isEmpty [IsEmpty ğ“§] : minimaxRisk â„“ P = 0 := by
  simp [minimaxRisk, Subsingleton.elim P 0]

@[simp]
lemma minimaxRisk_of_isEmpty' [Nonempty ğ“§] [IsEmpty ğ“¨] : minimaxRisk â„“ P = âˆ := by
  have : IsEmpty (Subtype (@IsMarkovKernel ğ“§ ğ“¨ mğ“§ mğ“¨)) := by
    simp only [isEmpty_subtype]
    exact fun Îº â†¦ Subsingleton.elim Îº 0 â–¸ Kernel.not_isMarkovKernel_zero
  simp [minimaxRisk, iInf_subtype']

@[simp]
lemma minimaxRisk_of_isEmpty'' [Nonempty ğ“¨] [IsEmpty Î˜] : minimaxRisk â„“ P = 0 := by
  simp [minimaxRisk, iInf_subtype']
end Empty

end ProbabilityTheory
