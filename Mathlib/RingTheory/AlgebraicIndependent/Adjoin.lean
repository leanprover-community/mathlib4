/-
Copyright (c) 2021 Chris Hughes. All rights reserved.
Released under Apache 2.0 license as described in the file LICENSE.
Authors: Chris Hughes
-/
import Mathlib.FieldTheory.IntermediateField.Adjoin.Algebra
import Mathlib.RingTheory.AlgebraicIndependent.Defs

/-!
# Algebraic Independence

This file concerns adjoining an algebraic independent family to a field.

## Main definitions

* `AlgebraicIndependent.aevalEquivField` - The canonical isomorphism from the rational function
  field ring to the intermediate field generated by an algebraic independent family.

* `AlgebraicIndependent.reprField` - The canonical map from the intermediate field generated by an
  algebraic independent family into the rational function field. It is the inverse of
  `AlgebraicIndependent.aevalEquivField`.
-/

noncomputable section

open Function Set Subalgebra MvPolynomial Algebra

namespace AlgebraicIndependent

variable {ι : Type*}
variable {F E : Type*} {x : ι → E} [Field F] [Field E] [Algebra F E] (hx : AlgebraicIndependent F x)
include hx

/-- Canonical isomorphism between rational function field and the
  intermediate field generated by algebraically independent elements. -/
def aevalEquivField :
    FractionRing (MvPolynomial ι F) ≃ₐ[F] ↥(IntermediateField.adjoin F (range x)) :=
  let i := IsFractionRing.liftAlgHom (K := FractionRing (MvPolynomial ι F))
    (algebraicIndependent_iff_injective_aeval.2 hx)
  (show _ ≃ₐ[F] i.fieldRange from AlgEquiv.ofInjectiveField i).trans <|
    IntermediateField.equivOfEq <|
      IsFractionRing.algHom_fieldRange_eq_of_comp_eq_of_range_eq (g := aeval x) (f := i)
        (by ext <;> simp [i]) (Algebra.adjoin_range_eq_range_aeval F x).symm

@[simp]
theorem aevalEquivField_apply_coe (a : FractionRing (MvPolynomial ι F)) :
    hx.aevalEquivField a =
      IsFractionRing.lift (algebraicIndependent_iff_injective_aeval.2 hx) a := rfl

theorem aevalEquivField_algebraMap_apply_coe (a : MvPolynomial ι F) :
    hx.aevalEquivField (algebraMap _ _ a) = aeval x a := by
  simp

/-- The canonical map from the intermediate field generated by an algebraic independent family
  into the rational function field. -/
def reprField : IntermediateField.adjoin F (range x) →ₐ[F] FractionRing (MvPolynomial ι F) :=
  hx.aevalEquivField.symm

@[simp]
theorem lift_reprField (p) :
    IsFractionRing.lift (algebraicIndependent_iff_injective_aeval.2 hx) (hx.reprField p) = p :=
  Subtype.ext_iff.1 (AlgEquiv.apply_symm_apply hx.aevalEquivField p)

theorem liftAlgHom_comp_reprField :
    (IsFractionRing.liftAlgHom (algebraicIndependent_iff_injective_aeval.2 hx)).comp hx.reprField =
      IntermediateField.val _ :=
  AlgHom.ext <| hx.lift_reprField

end AlgebraicIndependent
