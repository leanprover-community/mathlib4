/-
Copyright (c) 2025 Jireh Loreaux. All rights reserved.
Released under Apache 2.0 license as described in the file LICENSE.
Authors: Jireh Loreaux
-/
import Mathlib.Analysis.CStarAlgebra.ContinuousFunctionalCalculus.Instances
import Mathlib.Topology.ContinuousMap.ContinuousSqrt

/-! # Range of the continuous functional calculus

This file contains results about the range of the continuous functional calculus, and
consequences thereof.

# Main results

* `range_cfcHom` and `range_cfcâ‚™Hom`: for `RCLike` scalar rings, the range of the continuous
  functional calculus homomorphism is the elemental subalgebra generated by the given element.
* `range_cfc_nnreal` and `range_cfcâ‚™_nnreal`: over the scalar semiring `â„â‰¥0`, the range of the
  continuous functional calculus consists of the nonnegative elements in the elemental `â„`-algebra
  generated by the given element.

-/

open Topology

open scoped CStarAlgebra

section Unital

section RCLike

variable (ğ•œ : Type*) {A : Type*} {p : A â†’ Prop} [RCLike ğ•œ] [Ring A] [StarRing A] [Algebra ğ•œ A]
variable [TopologicalSpace A] [StarModule ğ•œ A] [ContinuousFunctionalCalculus ğ•œ A p]
variable [IsTopologicalRing A] [ContinuousStar A]

open StarAlgebra

open scoped ContinuousFunctionalCalculus in
theorem range_cfcHom {a : A} (ha : p a) :
    (cfcHom ha (R := ğ•œ)).range = elemental ğ•œ a := by
  rw [StarAlgHom.range_eq_map_top, â† ContinuousMap.elemental_id_eq_top, StarAlgebra.elemental,
    â† StarSubalgebra.topologicalClosure_map _ _ (cfcHom_isClosedEmbedding ha (R := ğ•œ)).isClosedMap
      (cfcHom_continuous ha), StarAlgHom.map_adjoin]
  congr
  simpa using cfcHom_id ha

lemma range_cfc {a : A} (ha : p a) : Set.range (cfc (R := ğ•œ) Â· a) = elemental ğ•œ a := by
  rw [range_cfc_eq_range_cfcHom ğ•œ ha, range_cfcHom ğ•œ ha]

variable {ğ•œ}

theorem cfcHom_apply_mem_elemental {a : A} (ha : p a) (f : C(spectrum ğ•œ a, ğ•œ)) :
    cfcHom ha f âˆˆ elemental ğ•œ a :=
  range_cfcHom ğ•œ ha â–¸ âŸ¨f, rflâŸ©

@[simp, grind â†]
theorem cfc_apply_mem_elemental (f : ğ•œ â†’ ğ•œ) (a : A) :
    cfc f a âˆˆ elemental ğ•œ a :=
  cfc_cases _ a f (zero_mem _) fun hf ha â†¦
    cfcHom_apply_mem_elemental ha âŸ¨_, hf.restrictâŸ©

end RCLike

open scoped NNReal
variable {A : Type*} [Ring A] [StarRing A] [Algebra â„ A] [TopologicalSpace A]
variable [ContinuousFunctionalCalculus â„ A IsSelfAdjoint] [IsTopologicalRing A] [T2Space A]
variable [PartialOrder A] [NonnegSpectrumClass â„ A] [StarOrderedRing A]

lemma range_cfc_nnreal_eq_image_cfc_real (a : A) (ha : 0 â‰¤ a) :
    Set.range (cfc (R := â„â‰¥0) Â· a) = (cfc Â· a) '' {f | âˆ€ x âˆˆ spectrum â„ a, 0 â‰¤ f x} := by
  ext
  constructor
  Â· rintro âŸ¨f, rflâŸ©
    simp only [cfc_nnreal_eq_real f a ha]
    exact âŸ¨_, fun _ _ â†¦ by positivity, rflâŸ©
  Â· rintro âŸ¨f, hf, rflâŸ©
    simp only [cfc_real_eq_nnreal a hf]
    exact âŸ¨_, rflâŸ©

variable [ContinuousStar A] [StarModule â„ A]

lemma range_cfc_nnreal (a : A) (ha : 0 â‰¤ a) :
    Set.range (cfc (R := â„â‰¥0) Â· a) = {x | x âˆˆ StarAlgebra.elemental â„ a âˆ§ 0 â‰¤ x} := by
  rw [range_cfc_nnreal_eq_image_cfc_real a ha, Set.setOf_and, SetLike.setOf_mem_eq,
    â† range_cfc _ ha.isSelfAdjoint, Set.inter_comm, â† Set.image_preimage_eq_inter_range]
  refine Set.Subset.antisymm (Set.image_mono (fun _ â†¦ cfc_nonneg)) ?_
  rintro _ âŸ¨f, hf, rflâŸ©
  simp only [Set.preimage_setOf_eq, Set.mem_setOf_eq, Set.mem_image] at hf âŠ¢
  obtain (âŸ¨hâ‚, hâ‚‚âŸ© | h | h) := by
    simpa only [not_and_or] using em (ContinuousOn f (spectrum â„ a) âˆ§ IsSelfAdjoint a)
  Â· refine âŸ¨f, ?_, rflâŸ©
    rwa [cfc_nonneg_iff f a] at hf
  Â· exact âŸ¨0, by simp, by simp [cfc_apply_of_not_continuousOn a h]âŸ©
  Â· exact âŸ¨0, by simp, by simp [cfc_apply_of_not_predicate a h]âŸ©

end Unital

section NonUnital

section RCLike

variable (ğ•œ : Type*) {A : Type*} {p : A â†’ Prop} [RCLike ğ•œ] [NonUnitalRing A] [StarRing A]
variable [Module ğ•œ A] [IsScalarTower ğ•œ A A] [SMulCommClass ğ•œ A A]
variable [TopologicalSpace A] [NonUnitalContinuousFunctionalCalculus ğ•œ A p]
variable [ContinuousConstSMul ğ•œ A] [StarModule ğ•œ A] [IsTopologicalRing A] [ContinuousStar A]

open NonUnitalStarAlgebra

open scoped NonUnitalContinuousFunctionalCalculus in
theorem range_cfcâ‚™Hom {a : A} (ha : p a) :
    NonUnitalStarAlgHom.range (cfcâ‚™Hom ha (R := ğ•œ)) = elemental ğ•œ a := by
  rw [â† NonUnitalStarAlgebra.map_top, â† ContinuousMapZero.elemental_eq_top,
    NonUnitalStarAlgebra.elemental, â† NonUnitalStarSubalgebra.topologicalClosure_map _
    (cfcâ‚™Hom_isClosedEmbedding ha (R := ğ•œ)).isClosedMap (cfcâ‚™Hom_continuous ha),
    NonUnitalStarAlgHom.map_adjoin]
  congr
  simpa using cfcâ‚™Hom_id ha

theorem range_cfcâ‚™ {a : A} (ha : p a) : Set.range (cfcâ‚™ (R := ğ•œ) Â· a) = elemental ğ•œ a := by
  rw [range_cfcâ‚™_eq_range_cfcâ‚™Hom ğ•œ ha, range_cfcâ‚™Hom ğ•œ ha]

variable {ğ•œ}

open scoped ContinuousMapZero

theorem cfcâ‚™Hom_apply_mem_elemental {a : A} (ha : p a) (f : C(quasispectrum ğ•œ a, ğ•œ)â‚€) :
    cfcâ‚™Hom ha f âˆˆ elemental ğ•œ a :=
  range_cfcâ‚™Hom ğ•œ ha â–¸ âŸ¨f, rflâŸ©

@[simp, grind â†]
theorem cfcâ‚™_apply_mem_elemental (f : ğ•œ â†’ ğ•œ) (a : A) :
    cfcâ‚™ f a âˆˆ elemental ğ•œ a :=
  cfcâ‚™_cases _ a f (zero_mem _) fun hf hfâ‚€ ha â†¦
    cfcâ‚™Hom_apply_mem_elemental ha âŸ¨âŸ¨_, hf.restrictâŸ©, hfâ‚€âŸ©

end RCLike

open scoped NNReal
variable {A : Type*} [NonUnitalRing A] [StarRing A] [Module â„ A] [IsScalarTower â„ A A]
variable [SMulCommClass â„ A A] [TopologicalSpace A]
variable [NonUnitalContinuousFunctionalCalculus â„ A IsSelfAdjoint] [IsTopologicalRing A] [T2Space A]
variable [PartialOrder A] [NonnegSpectrumClass â„ A] [StarOrderedRing A]

lemma range_cfcâ‚™_nnreal_eq_image_cfcâ‚™_real (a : A) (ha : 0 â‰¤ a) :
    Set.range (cfcâ‚™ (R := â„â‰¥0) Â· a) = (cfcâ‚™ Â· a) '' {f | âˆ€ x âˆˆ quasispectrum â„ a, 0 â‰¤ f x} := by
  ext
  constructor
  Â· rintro âŸ¨f, rflâŸ©
    simp only [cfcâ‚™_nnreal_eq_real f a]
    exact âŸ¨_, fun _ _ â†¦ by positivity, rflâŸ©
  Â· rintro âŸ¨f, hf, rflâŸ©
    simp only [cfcâ‚™_real_eq_nnreal a hf]
    exact âŸ¨_, rflâŸ©

variable [StarModule â„ A] [ContinuousStar A] [ContinuousConstSMul â„ A]

lemma range_cfcâ‚™_nnreal (a : A) (ha : 0 â‰¤ a) :
    Set.range (cfcâ‚™ (R := â„â‰¥0) Â· a) = {x | x âˆˆ NonUnitalStarAlgebra.elemental â„ a âˆ§ 0 â‰¤ x} := by
  rw [range_cfcâ‚™_nnreal_eq_image_cfcâ‚™_real a ha, Set.setOf_and, SetLike.setOf_mem_eq,
    â† range_cfcâ‚™ _ ha.isSelfAdjoint, Set.inter_comm, â† Set.image_preimage_eq_inter_range]
  refine Set.Subset.antisymm (Set.image_mono (fun _ â†¦ cfcâ‚™_nonneg)) ?_
  rintro _ âŸ¨f, hf, rflâŸ©
  simp only [Set.preimage_setOf_eq, Set.mem_setOf_eq, Set.mem_image] at hf âŠ¢
  obtain (âŸ¨hâ‚, hâ‚‚, hâ‚ƒâŸ© | h | h | h) := by
    simpa only [not_and_or] using
      em (ContinuousOn f (quasispectrum â„ a) âˆ§ f 0 = 0 âˆ§ IsSelfAdjoint a)
  Â· refine âŸ¨f, ?_, rflâŸ©
    rwa [cfcâ‚™_nonneg_iff f a] at hf
  Â· exact âŸ¨0, by simp, by simp [cfcâ‚™_apply_of_not_continuousOn a h]âŸ©
  Â· exact âŸ¨0, by simp, by simp [cfcâ‚™_apply_of_not_map_zero a h]âŸ©
  Â· exact âŸ¨0, by simp, by simp [cfcâ‚™_apply_of_not_predicate a h]âŸ©

end NonUnital
