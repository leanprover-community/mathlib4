## RFC: Commit Verification CI

Kim and I propose that we add CI checks to verify that PRs correctly use transient and automated commits, and provide reviewers with a clear summary of which commits need human review.

Large PRs often contain a mix of:
- Substantive changes requiring careful review
- Automated fixes (e.g., mass renaming, formatting) generated by scripts
- Temporary commits that have no net effect

This makes review harder and clutters git history. We want to formalize patterns for marking these commit types and automatically verify their correctness.

### 1. Automated Commits

**Format**: Commit messages of the form `x: <shell-command>`

**Semantics**: The commit is the exact result of running `<shell-command>` on the parent commit's checkout.

**Verification**: For each such commit, CI:
1. Verifies the commit has exactly one parent
2. Checks out the parent commit
3. Executes `<shell-command>` in a sandboxed environment
4. Compares the resulting tree to the commit's tree

**Example use cases**:
```
abc213: x: scripts/add_deprecations.sh
```

**Sandbox requirements**:
- Restrict network access
- Timeout limits (~10 min)
- Memory/CPU limits
- Runs in CI container (same security boundary as other CI jobs)

### 2. Transient Commits

**Format**: Commit messages starting with `transient`

**Semantics**: These commits should have zero net effect on the final tree.

**Verification**: CI computes the tree hash of HEAD and compares it to the tree hash obtained by rebasing the PR with all transient commits removed. If they differ, CI fails.

**Example use case**:
```
abc123: transient: set_option pp.all true
def456: fix: improve proof readability
ghi789: transient: remove set_option pp.all true
```
Final diff is identical to a version without the transient commits.

Combining with automated commits:
```
abc123: transient: add scripts/specialized_refactor.sh
def456: x: scripts/specialized_refactor.sh
ghi789: transient: remove scripts/specialized_refactor.sh
```

### 3. Review Summary

CI posts a comment categorizing all commits:
- link to the diff of substantive commits needing review
- list of automated commits
- green checkmark in CI status if automated and transient commits verified successfully

This allows reviewers to focus on substantive changes while having confidence that automated and transient commits were verified.

### Edge Cases

1. **Non-deterministic commands**: Commands that produce different output on each run (timestamps, etc.) will fail verification. Authors should avoid these or make them deterministic.
2. **Merge commits**: Automated commits must have exactly one parent, so merge commits cannot use the `x:` prefix.
3. **Force pushes**: Verification runs on the current HEAD, so rewriting history triggers re-verification.
